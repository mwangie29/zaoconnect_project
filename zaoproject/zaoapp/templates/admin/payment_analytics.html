{% extends 'base.html' %}
{% load static %}

{% block title %}Payment Analytics - Admin Dashboard{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
<style>
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #2196F3;
    }
    
    .metric-card.success {
        border-left-color: #4CAF50;
    }
    
    .metric-card.danger {
        border-left-color: #f44336;
    }
    
    .metric-value {
        font-size: 28px;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
    }
    
    .metric-label {
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
    }
    
    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        position: relative;
        height: 400px;
    }
    
    .table-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .status-badge {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-paid {
        background-color: #4CAF50;
        color: white;
    }
    
    .status-failed {
        background-color: #f44336;
        color: white;
    }
    
    .status-pending {
        background-color: #ff9800;
        color: white;
    }
    
    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
    }
    
    .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        color: #666;
        font-size: 14px;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }
    
    .tab.active {
        color: #2196F3;
        border-bottom-color: #2196F3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Payment Analytics Dashboard</h1>
    
    <!-- Time Range Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="showMetrics('7days')">Last 7 Days</button>
        <button class="tab" onclick="showMetrics('30days')">Last 30 Days</button>
        <button class="tab" onclick="showMetrics('90days')">Last 90 Days</button>
    </div>
    
    <!-- Metrics Cards -->
    <div id="metrics-7days" class="metrics-section">
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Transactions</div>
                <div class="metric-value">{{ metrics_7days.total }}</div>
            </div>
            <div class="metric-card success">
                <div class="metric-label">Successful Payments</div>
                <div class="metric-value">{{ metrics_7days.paid }}</div>
            </div>
            <div class="metric-card danger">
                <div class="metric-label">Failed Payments</div>
                <div class="metric-value">{{ metrics_7days.failed }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Revenue</div>
                <div class="metric-value">KES {{ metrics_7days.revenue|floatformat:2 }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Amount</div>
                <div class="metric-value">KES {{ metrics_7days.avg_amount|floatformat:2 }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Success Rate</div>
                <div class="metric-value">{{ metrics_7days.success_rate }}%</div>
            </div>
        </div>
    </div>
    
    <div id="metrics-30days" class="metrics-section" style="display:none;">
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Transactions</div>
                <div class="metric-value">{{ metrics_30days.total }}</div>
            </div>
            <div class="metric-card success">
                <div class="metric-label">Successful Payments</div>
                <div class="metric-value">{{ metrics_30days.paid }}</div>
            </div>
            <div class="metric-card danger">
                <div class="metric-label">Failed Payments</div>
                <div class="metric-value">{{ metrics_30days.failed }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Revenue</div>
                <div class="metric-value">KES {{ metrics_30days.revenue|floatformat:2 }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Amount</div>
                <div class="metric-value">KES {{ metrics_30days.avg_amount|floatformat:2 }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Success Rate</div>
                <div class="metric-value">{{ metrics_30days.success_rate }}%</div>
            </div>
        </div>
    </div>
    
    <div id="metrics-90days" class="metrics-section" style="display:none;">
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Transactions</div>
                <div class="metric-value">{{ metrics_90days.total }}</div>
            </div>
            <div class="metric-card success">
                <div class="metric-label">Successful Payments</div>
                <div class="metric-value">{{ metrics_90days.paid }}</div>
            </div>
            <div class="metric-card danger">
                <div class="metric-label">Failed Payments</div>
                <div class="metric-value">{{ metrics_90days.failed }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Revenue</div>
                <div class="metric-value">KES {{ metrics_90days.revenue|floatformat:2 }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Amount</div>
                <div class="metric-value">KES {{ metrics_90days.avg_amount|floatformat:2 }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Success Rate</div>
                <div class="metric-value">{{ metrics_90days.success_rate }}%</div>
            </div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="row">
        <div class="col-md-8">
            <div class="chart-container">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent Transactions Table -->
    <div class="table-container">
        <h3 class="mb-4">Recent Transactions</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>M-Pesa Receipt</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in recent_transactions %}
                <tr>
                    <td>#{{ transaction.order.id }}</td>
                    <td>KES {{ transaction.amount|floatformat:2 }}</td>
                    <td>
                        <span class="status-badge status-{{ transaction.status }}">
                            {{ transaction.get_status_display }}
                        </span>
                    </td>
                    <td>{{ transaction.initiated_at|date:"M d, Y H:i" }}</td>
                    <td>{{ transaction.mpesa_receipt|default:"N/A" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted">No transactions yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
function showMetrics(timeRange) {
    // Hide all sections
    document.querySelectorAll('.metrics-section').forEach(el => el.style.display = 'none');
    
    // Show selected section
    document.getElementById('metrics-' + timeRange).style.display = 'block';
    
    // Update active tab
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    event.target.classList.add('active');
}

// Daily transactions chart
const dailyCtx = document.getElementById('dailyChart').getContext('2d');
const dailyData = {{ daily_data|safe }};

const dates = dailyData.map(d => d.date);
const transactions = dailyData.map(d => d.transactions);
const successful = dailyData.map(d => d.successful);
const failed = dailyData.map(d => d.failed);

new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: dates,
        datasets: [
            {
                label: 'Total Transactions',
                data: transactions,
                borderColor: '#2196F3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                tension: 0.4,
            },
            {
                label: 'Successful',
                data: successful,
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.4,
            },
            {
                label: 'Failed',
                data: failed,
                borderColor: '#f44336',
                backgroundColor: 'rgba(244, 67, 54, 0.1)',
                tension: 0.4,
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: 'Daily Transactions (Last 30 Days)'
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Status breakdown pie chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusData = {{ status_breakdown|safe }};

new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Paid', 'Failed', 'Pending'],
        datasets: [{
            data: [statusData.paid, statusData.failed, statusData.pending],
            backgroundColor: [
                '#4CAF50',
                '#f44336',
                '#ff9800'
            ],
            borderColor: '#fff',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            },
            title: {
                display: true,
                text: 'Payment Status Breakdown'
            }
        }
    }
});
</script>
{% endblock %}
